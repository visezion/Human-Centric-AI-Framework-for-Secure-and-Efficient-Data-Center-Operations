version: "3.9"

services:
  mosquitto:
    image: eclipse-mosquitto:2.0.20
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./mosquitto/passwordfile:/mosquitto/config/passwordfile:ro

  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    restart: unless-stopped
    ports:
      - "8086:8086"
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: human_admin
      DOCKER_INFLUXDB_INIT_PASSWORD: changeme123
      DOCKER_INFLUXDB_INIT_ORG: human-centric
      DOCKER_INFLUXDB_INIT_BUCKET: telemetry
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: supersecret-supertoken
    volumes:
      - influxdb-data:/var/lib/influxdb2
      - influxdb-config:/etc/influxdb2

  telegraf:
    image: telegraf:1.30
    container_name: telegraf
    restart: unless-stopped
    depends_on:
      - influxdb
      - mosquitto
    environment:
      INFLUX_TOKEN: supersecret-supertoken
      MQTT_USERNAME: hcai_operator
      MQTT_PASSWORD: ${MQTT_PASSWORD:?Set MQTT_PASSWORD env var}
    volumes:
      - ./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
    links:
      - influxdb

  grafana:
    image: grafana/grafana:10.4.3
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin123
      INFLUXDB_ADMIN_TOKEN: supersecret-supertoken
      GF_INSTALL_PLUGINS: simpod-json-datasource
      AI_API_URL: https://ai.vicezion.com
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - influxdb

  ai_service:
    image: ghcr.io/visezion/hcai-ai:latest
    container_name: ai-service
    restart: unless-stopped
    ports:
      - "8010:8000"
    labels:
      com.centurylinklabs.watchtower.enable: "true"

    environment:
      FLASK_ENV: production
      MODEL_NAME: sentry-lite-vae
      MLFLOW_TRACKING_URI: https://mlflow.vicezion.com
      MLFLOW_EXPERIMENT_NAME: human-centric-ai
      ENABLE_VAE: "true"
      MODEL_ARTIFACT_PATH: /app/models/isolation_forest_green.joblib
    volumes:
      - ./ai_service/models:/app/models:ro
    depends_on:
      - mlflow

  telemetry_feeder:
    image: ghcr.io/visezion/hcai-feeder:latest
    container_name: telemetry-feeder
    restart: unless-stopped
    labels:
      com.centurylinklabs.watchtower.enable: "true"
    environment:
      MQTT_BROKER_HOST: mqtt.vicezion.com
      MQTT_USERNAME: hcai_operator
      MQTT_PASSWORD: ${MQTT_PASSWORD:?Set MQTT_PASSWORD env var}
      MQTT_TOPIC_PREFIX: sensors
      AI_SERVICE_URL: https://ai.vicezion.com/predict
      PUBLISH_INTERVAL_SECONDS: "5"
    depends_on:
      - mosquitto
      - ai_service

  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.16.0
    container_name: mlflow
    restart: unless-stopped
    ports:
      - "5001:5000"
    labels:
      com.centurylinklabs.watchtower.enable: "true"

    environment:
      MLFLOW_S3_IGNORE_TLS: "true"
    command: >-
      mlflow server --host 0.0.0.0 --port 5000
      --backend-store-uri sqlite:////mlflow/mlflow.db
      --default-artifact-root /mlflow/artifacts
    volumes:
      - mlflow-data:/mlflow

  chatops:
    image: ghcr.io/visezion/hcai-chatops:latest
    container_name: chatops
    restart: unless-stopped
    ports:
      - "8500:8500"
    labels:
      com.centurylinklabs.watchtower.enable: "true"

    environment:
      AI_SERVICE_URL: https://ai.vicezion.com/predict
      INFLUX_URL: https://influx.vicezion.com
      INFLUX_ORG: human-centric
      INFLUX_BUCKET: telemetry
      INFLUX_TOKEN: supersecret-supertoken
    depends_on:
      - ai_service
      - influxdb

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    user: root
    ports:
      - "9091:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro


volumes:
  influxdb-data:
  influxdb-config:
  grafana-data:
  mlflow-data:
